// Application Insights module for observability\n@description('Application Insights name')\nparam name string\n\n@description('Location for Application Insights')\nparam location string\n\n@description('Environment name')\nparam environmentName string\n\n// Log Analytics Workspace (required for Application Insights)\nresource logAnalyticsWorkspace 'Microsoft.OperationalInsights/workspaces@2023-09-01' = {\n  name: '${name}-law'\n  location: location\n  tags: {\n    Environment: environmentName\n    Application: 'CodeQL-Compliance-Dashboard'\n    ManagedBy: 'Bicep'\n  }\n  properties: {\n    sku: {\n      name: 'PerGB2018'\n    }\n    retentionInDays: environmentName == 'prod' ? 90 : 30\n    features: {\n      enableLogAccessUsingOnlyResourcePermissions: true\n    }\n    publicNetworkAccessForIngestion: 'Enabled'\n    publicNetworkAccessForQuery: 'Enabled'\n  }\n}\n\n// Application Insights resource\nresource appInsights 'Microsoft.Insights/components@2020-02-02' = {\n  name: name\n  location: location\n  kind: 'web'\n  tags: {\n    Environment: environmentName\n    Application: 'CodeQL-Compliance-Dashboard'\n    ManagedBy: 'Bicep'\n  }\n  properties: {\n    Application_Type: 'web'\n    WorkspaceResourceId: logAnalyticsWorkspace.id\n    RetentionInDays: environmentName == 'prod' ? 90 : 30\n    publicNetworkAccessForIngestion: 'Enabled'\n    publicNetworkAccessForQuery: 'Enabled'\n  }\n}\n\n// Standard dashboard queries for CodeQL Compliance Dashboard\nresource workbook 'Microsoft.Insights/workbooks@2022-04-01' = {\n  name: guid(appInsights.id, 'codeql-dashboard')\n  location: location\n  kind: 'shared'\n  tags: {\n    Environment: environmentName\n    Application: 'CodeQL-Compliance-Dashboard'\n    ManagedBy: 'Bicep'\n  }\n  properties: {\n    displayName: 'CodeQL Compliance Dashboard Metrics'\n    serializedData: json({\n      version: 'Notebook/1.0'\n      items: [\n        {\n          type: 1\n          content: {\n            json: '## CodeQL Compliance Dashboard Metrics\\n\\nThis workbook provides insights into the CodeQL compliance scanning operations.'\n          }\n        }\n        {\n          type: 3\n          content: {\n            version: 'KqlItem/1.0'\n            query: 'requests\\n| where timestamp > ago(7d)\\n| where url contains \"api/\"\\n| summarize count() by bin(timestamp, 1h), resultCode\\n| order by timestamp desc'\n            size: 0\n            title: 'API Request Volume (Last 7 Days)'\n            visualization: 'timechart'\n          }\n        }\n        {\n          type: 3\n          content: {\n            version: 'KqlItem/1.0'\n            query: 'customEvents\\n| where timestamp > ago(7d)\\n| where name == \"ScanDispatched\"\\n| summarize count() by bin(timestamp, 1d)\\n| order by timestamp desc'\n            size: 0\n            title: 'Scans Dispatched (Last 7 Days)'\n            visualization: 'barchart'\n          }\n        }\n      ]\n    })\n    category: 'workbook'\n  }\n}\n\n// Output values\noutput name string = appInsights.name\noutput id string = appInsights.id\noutput instrumentationKey string = appInsights.properties.InstrumentationKey\noutput connectionString string = appInsights.properties.ConnectionString\noutput workspaceId string = logAnalyticsWorkspace.id
