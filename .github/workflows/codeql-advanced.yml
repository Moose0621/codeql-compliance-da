name: "CodeQL On-Demand Scan"

on:
  workflow_dispatch:
    inputs:
      languages:
        description: 'Languages to analyze (comma-separated: javascript,typescript,python,java,csharp,cpp,go,ruby)'
        required: false
        default: 'javascript,typescript'
      scan-type:
        description: 'Type of scan to perform'
        required: false
        default: 'security-extended'
        type: choice
        options:
          - security-extended
          - security-and-quality
          - custom
      custom-queries:
        description: 'Custom query suite (if scan-type is custom)'
        required: false
        default: ''
      ref:
        description: 'Git reference to scan (branch/tag/commit)'
        required: false
        default: 'main'

permissions:
  actions: read
  contents: read
  security-events: write
  id-token: write

jobs:
  on-demand-scan:
    name: On-Demand CodeQL Scan (${{ matrix.language }})
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    timeout-minutes: ${{ (matrix.language == 'swift' && 120) || 360 }}
    
    strategy:
      fail-fast: false
      matrix:
        # Support common language combinations
        include:
          - language: 'javascript'
            display-name: 'JavaScript/TypeScript'
          - language: 'python' 
            display-name: 'Python'
          - language: 'java'
            display-name: 'Java'
          - language: 'csharp'
            display-name: 'C#'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.ref || 'main' }}

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: ${{ github.event.inputs.custom-queries || (github.event.inputs.scan-type == 'security-and-quality' && '+security-and-quality' || '+security-extended') }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ matrix.language }}/on-demand"
        upload: true
        
    - name: Create scan summary
      uses: actions/github-script@v7
      with:
        script: |
          const scanInfo = {
            languages: '${{ matrix.language }}',
            scanType: '${{ github.event.inputs.scan-type }}',
            ref: '${{ github.event.inputs.ref || github.ref }}',
            timestamp: new Date().toISOString(),
            triggeredBy: '${{ github.actor }}'
          };
          
          core.summary
            .addHeading('üîç On-Demand CodeQL Scan Complete')
            .addTable([
              [{data: 'Property', header: true}, {data: 'Value', header: true}],
              ['Language', scanInfo.languages],
              ['Scan Type', scanInfo.scanType],
              ['Reference', scanInfo.ref],
              ['Triggered By', scanInfo.triggeredBy],
              ['Completed', scanInfo.timestamp]
            ])
            .addLink('View Security Alerts', `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/security/code-scanning`)
            .write();
            